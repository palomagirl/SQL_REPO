select * from
(select customer_id, rental_id, rental_date, inventory_id, 
row_number()over 
(partition by customer_id order by  customer_id,rental_date desc) as customer_date_ranks
from rental)a
where customer_Date_ranks= 4 ----- here we select 4th record for each customer

for every customer(partition by customerid) get 4th record based on 
rentaldate order by (customer_id,rental_date desc)
(rownum to give rownumber to each row within customer)


customer_id, rental_id, rental_date, inventory_id, 
1	14762	"2005-08-21 23:33:57"	4249	"4"
2	14475	"2005-08-21 13:24:32"	3164	"4"
3	13610	"2005-08-20 06:14:12"	2526	"4"
4	13807	"2005-08-20 12:55:40"	3822	"4"
5	14430	"2005-08-21 11:31:11"	2623	"4"
6	14329	"2005-08-21 08:22:56"	3544	"4"
7	13373	"2005-08-19 21:23:31"	4045	"4"
8	14114	"2005-08-21 01:07:11"	2270	"4"
9	12309	"2005-08-18 05:58:40"	762	"4"
10	12400	"2005-08-18 09:19:12"	1767	"4"
11	13790	"2005-08-20 12:17:27"	1385	"4"
12	13519	"2005-08-20 02:37:07"	182	"4"
13	13456	"2005-08-20 00:33:19"	1644	"4"


--This lists all customers withtheir rownumber records
--rownuber resets with every new customerid(parition)
--notice customer_id 2 starts with date_rank 1

select customer_id, rental_id, rental_date, inventory_id, 
row_number()over 
(partition by customer_id order by  customer_id,rental_date desc) as customer_date_ranks
from rental

customer_id, rental_id, rental_date, inventory_id,  customer_date_ranks
1	15315	"2005-08-22 20:03:46"	312	"1"
1	15298	"2005-08-22 19:41:37"	1446	"2"
1	14825	"2005-08-22 01:27:57"	1449	"3"
1	14762	"2005-08-21 23:33:57"	4249	"4"
1	13176	"2005-08-19 13:56:54"	2269	"5"
1	13068	"2005-08-19 09:55:16"	3019	"6"
1	12250	"2005-08-18 03:57:29"	921	"7"
1	11824	"2005-08-17 12:37:54"	2639	"8"
1	11367	"2005-08-02 18:01:38"	1440	"9"
1	11299	"2005-08-02 15:36:52"	3232	"10"
1	10437	"2005-08-01 08:51:04"	14	"11"
1	9571	"2005-07-31 02:42:18"	2219	"12"
1	8326	"2005-07-29 03:58:49"	108	"13"
1	8116	"2005-07-28 19:20:07"	4497	"14"
1	8074	"2005-07-28 17:33:39"	1558	"15"
1	8033	"2005-07-28 16:18:23"	4268	"16"
1	7841	"2005-07-28 09:04:45"	1092	"17"
1	7273	"2005-07-27 11:31:22"	2465	"18"
1	6163	"2005-07-11 10:13:46"	1330	"19"
1	5326	"2005-07-09 16:38:01"	797	"20"
1	5244	"2005-07-09 13:24:07"	3726	"21"
1	4611	"2005-07-08 07:33:56"	3486	"22"
1	4526	"2005-07-08 03:17:05"	1443	"23"
1	3284	"2005-06-21 06:24:45"	4566	"24"
1	2363	"2005-06-18 13:33:59"	3497	"25"
1	2308	"2005-06-18 08:41:48"	197	"26"
1	1725	"2005-06-16 15:18:57"	726	"27"
1	1476	"2005-06-15 21:08:46"	1407	"28"
1	1422	"2005-06-15 18:02:53"	1021	"29"
1	1185	"2005-06-15 00:54:12"	2785	"30"
1	573	"2005-05-28 10:35:23"	4020	"31"
1	76	"2005-05-25 11:30:37"	3021	"32"
2	15907	"2005-08-23 17:39:35"	2898	"1"
2	15145	"2005-08-22 13:53:04"	2179	"2"
2	14743	"2005-08-21 22:41:56"	4570	"3"
2	14475	"2005-08-21 13:24:32"	3164	"4"
2	12963	"2005-08-19 06:26:04"	1521	"5"
2	11614	"2005-08-17 03:52:18"	805	"6"
2	11256	"2005-08-02 13:44:53"	2060	"7"
2	11177	"2005-08-02 10:43:48"	1149	"8"
2	11087	"2005-08-02 07:41:41"	654	"9"
2	10918	"2005-08-02 02:10:56"	3418	"10"
2	10466	"2005-08-01 09:45:26"	138	"11"
2	10136	"2005-07-31 21:58:56"	3142	"12"
2	9465	"2005-07-30 22:39:53"	3084	"13"
2	9296	"2005-07-30 16:21:13"	4088	"14"
2	9248	"2005-07-30 14:14:11"	1382	"15"
2	9236	"2005-07-30 13:47:43"	4030	"16"
2	9031	"2005-07-30 06:06:10"	2377	"17"
2	8705	"2005-07-29 17:14:29"	4038	"18"
2	8598	"2005-07-29 12:56:59"	626	"19"
2	8230	"2005-07-29 00:12:59"	1937	"20"
2	7459	"2005-07-27 18:40:20"	2053	"21"
2	7376	"2005-07-27 15:23:02"	488	"22"
2	7346	"2005-07-27 14:30:42"	741	"23"
2	5755	"2005-07-10 12:38:56"	2760	"24"
2	5636	"2005-07-10 06:31:24"	4116	"25"
2	2128	"2005-06-17 20:54:58"	352	"26"
2	320	"2005-05-27 00:09:24"	1090	"27"
3	15619	"2005-08-23 07:10:14"	2468	"1"
3	15038	"2005-08-22 09:37:27"	1685	"2"
3	14699	"2005-08-21 20:50:48"	1427	"3"
3	13610	"2005-08-20 06:14:12"	2526	"4"
3	13403	"2005-08-19 22:18:07"	3241	"5"
